// ==UserScript==
// @name         Rodeooooooooo
// @version      1.3.0.1
// @author       Edited by gavalda BCN1 original author niszct POZ1
// @connect      amazon.com
// @match        https://rodeo-dub.amazon.com/*/ItemList*
// @supportURL   mailto://gavalda@amazon.com
// @supportURL   mailto://gavalda@amazon.com
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// @run-at       document-body
// ==/UserScript==
var ButtonDisabled = false;
var Initialized = false;
var SelectedRows = [];
var RowsScanned = 0;
var RowsToScan = 0;

var EmpOccursLogins = [];
var ShipmentsInfo = [];
var EmpOccursNb = [];
var ScheludedNb = 0;
var ScannerNb = 0;
var UnknownNb = 0;
var PickedNb = 0;

if ( typeof $ == 'undefined' ) {
        return;
}

GM_addStyle( 'table.shipment-list tr.tselected{background-color:#fd8 !important;}' );

function DoRequest( Row ) {
        var ShipmentID = $( 'a.aps-link', Row )[ 0 ].href.split( 'value=' )[ 1 ];
        var UserRow = $( 'td#UserID', Row );

        UserRow.css( 'background-color', '#ccc' );
        UserRow.empty().append( 'Checking...' );

        var Warehouse = $( 'input#fcpn-site-input' ).attr( 'value' );
        var TableHeaders = $( 'table' )[ 0 ].config.headerList;
        var BinID = '';
        var ASIN = '';

        for ( var i = 0; i < TableHeaders.length; i++ ) {
               var Title = $.trim( TableHeaders[ i ].innerText );

               if ( Title == 'FN SKU' ) {
                       ASIN = $.trim( Row.cells[ i ].innerText );
               } else if ( Title == 'Scannable ID' ) {
                       BinID = $.trim( Row.cells[ i ].innerText );
               }
        }

        GM_xmlhttpRequest( {
        url : 'https://picking-nexus.dub.amazon.com/' + Warehouse + '/pickinspector/CUSTOMER_SHIPMENT/' + ShipmentID,
        method : 'GET',
        onload : function() {
               var Response = $( this.responseText );
               var RowStatus = 'Unknown';
               var RowColor = '#f88';

               var DemandTable = $( 'table#demand_item_table tbody tr', Response );

               for ( var i = 0; i < DemandTable.length; i++ ) {
                       var Cells = $( 'td', DemandTable[ i ] );

                       var RowShipmentID = $.trim( Cells[ 2 ].innerText );
                       var RowBinID = $.trim( Cells[ 12 ].innerText );
                               var RowASIN = $.trim( Cells[ 4 ].innerText );
                       RowStatus = $.trim( Cells[ 0 ].innerText );

                       if ( typeof ShipmentsInfo[ RowShipmentID ] == 'undefined' ) {
                               ShipmentsInfo[ RowShipmentID ] = [];
                       }

                       if ( typeof ShipmentsInfo[ RowShipmentID ][ RowASIN ] == 'undefined' ) {
                               ShipmentsInfo[ RowShipmentID ][ RowASIN ] = [];

                               for ( var j = 0; j < DemandTable.length; j++ ) {
                                      ShipmentsInfo[ RowShipmentID ][ RowASIN ][ j ] = false;
                               }
                       }

                               if ( ASIN != RowASIN ) {
                                      continue;
                               }

                               if ( ShipmentsInfo[ RowShipmentID ][ RowASIN ][ i ] ) {
                                      continue;
                               }

                       if ( RowStatus == 'Picked' ) {
                               ShipmentsInfo[ RowShipmentID ][ RowASIN ][ i ] = true;
                               RowColor = '#8f8';
                               PickedNb++;
                               break;
                       }

                       if ( BinID != RowBinID ) {
                               continue;
                       }

                               ShipmentsInfo[ RowShipmentID ][ RowASIN ][ i ] = true;

                       if ( RowStatus == 'Scheduler Assigned' ) {
                               RowColor = '#faf4b4';
                               ScheludedNb++;
                               break;
                       }

                if ( RowStatus == 'Pending Picking' ) {
                    RowColor = '#0099ff';
                    UnknownNb++;
                    break;
                }

                       if ( RowStatus == 'In Scanner' ) {
                               RowStatus = $.trim( Cells[ 15 ].innerText );
                               RowColor = '#bbb';
                               ScannerNb++;

                               var Index = EmpOccursLogins.indexOf( RowStatus );

                               if ( Index == -1 ) {
                                       EmpOccursLogins.push( RowStatus );
                                      EmpOccursNb.push( 1 );
                                      break;
                               }

                               EmpOccursNb[ Index ]++;
                               break;
                       }
               }

               if ( RowColor == '#f88' ) {
                       UnknownNb++;
               }

               UserRow.css( 'background-color', RowColor );
               UserRow.empty().append( RowStatus );
               RowsScanned++;

               if ( RowsScanned == RowsToScan ) {
                       ButtonDisabled = false;
                       RowsScanned = 0;
                       RowsToScan = 0;

                       $( 'div#Stats' ).empty().append( '<b>Scheluded: ' + ScheludedNb + ' | In Scanner: ' + ScannerNb + ' | Picked: ' + PickedNb + ' | Unknown: ' + UnknownNb );
                       var UserIDs = $( 'td#UserID', 'table' );
                       var EmpOccs = $( 'td#EmpOcc', 'table' );

                       EmpOccs.each( function( Index ) {
                               var EmpIndex = EmpOccursLogins.indexOf( $.trim( UserIDs[ Index ].innerText ) );

                               if ( EmpIndex == -1 ) {
                                      this.innerText = '0';
                                      return;
                               }

                               this.innerText = EmpOccursNb[ EmpIndex ];
                       } );

                       if ( !Initialized ) {
                               $( 'table.shipment-list' ).tablesorter();
                               Initialized = true;
                       }
               }
        }
    } );
}

var LastClickedRow = -1;
var DisabledSelect = false;

$.fn.ready( function() {
        $( 'tr', 'table.shipment-list' ).each( function( Index ) {
               if ( Index == 0 ) {
                       var Rows = $( 'div.tablesorter-header-inner', this ).each( function( InnerIndex ) {
                               $( this ).parent().append( this.innerHTML );
                               $( this ).remove();
                       } );

                       $( this ).append( '<th style="text-align:center;width:96px;">User ID</th><th style="text-align:center;width:96px;">Occurs Num</th>' );
               } else {
                       $( this ).append( '<td id="UserID">Not checked yet</td>' );
                       $( this ).append( '<td id="EmpOcc">0</td>' );
               }
        } );

        var Image = $( '<div style="float:right;cursor:pointer;padding-top:4px;padding-right:2px;"><img src="/resources/images/rodeo-favicon.gif" style="width:19px">' );
        var Stats = $( '<div id="Stats" style="text-align:center;"></div>' );

        Image.click( function() {
               if ( ButtonDisabled ) {
                       return alert( 'In progress - please wait!' );
               }

               $( 'div#Stats' ).empty().append( '<b>Checking - Please wait!</b>' );
               var Rows = $( 'tr', 'tbody' );
               EmpOccursLogins = [];
               ShipmentsInfo = [];
               EmpOccursNb = [];
               ScheludedNb = 0;
               ScannerNb = 0;
               UnknownNb = 0;
               PickedNb = 0;

               if ( Rows.length == 0 ) {
                       return alert( 'There is nothing to search!' );
               }

               Rows.each( function() {
                       $( 'td#Occurs', this ).empty().append( '0' );
               } );

               if ( SelectedRows.length > 0 ) {
                       Rows = $( SelectedRows );
               }

               RowsToScan = Rows.length;
               ButtonDisabled = true;

               Rows.each( function() {
                       $( 'td#UserID', this ).empty().css( 'background-color', '#ccc' ).append( 'Checking...' );
                       var Row = this;

                       setTimeout( function() {
                               DoRequest( Row );
                       }, Math.min( Math.floor( ( Math.random() + 0.075 ) * 1500 ), 1500 ) );
               } );
        } );

        Image.insertAfter( 'div#link-open-in-new-tab' );
        Stats.insertAfter( 'div.pager-page-navigator' );

        $( 'table.shipment-list tbody tr' ).each( function() {
               this.m_Clicked = false;

               $( this ).click( function( Event ) {
                       var Index = SelectedRows.indexOf( this );
                       this.m_Clicked = !this.m_Clicked;

                       if ( Index != -1 && !this.m_Clicked ) {
                               SelectedRows.splice( Index, 1 );
                       } else if ( Index == -1 && this.m_Clicked ) {
                               SelectedRows.push( this );
                       }

            if ( !DisabledSelect && !Event.ctrlKey ) {
                LastClickedRow = -1;
            }

            if ( Event.ctrlKey && !DisabledSelect && LastClickedRow != -1 ) {
                var Diff = LastClickedRow - ( this.rowIndex - 1 );
                var IsDownSide = Diff < 0;
                Diff = Math.abs( Diff );

                if( Diff != 0 ) {
                    var Rows = $( 'table.shipment-list tbody tr' );
                    DisabledSelect = true;

                    for ( var i = 1; i < Diff; i++ ) {
                        $( Rows[ ( IsDownSide ? LastClickedRow : ( this.rowIndex - 1 ) ) + i ] ).click();
                    }

                    LastClickedRow = -1;
                    DisabledSelect = false;
                }
            } else if ( !DisabledSelect ) {
                LastClickedRow = this.rowIndex - 1;
            }

                       if ( this.m_Clicked ) {
                               $( this ).addClass( 'tselected' );
                       } else {
                               $( this ).removeClass( 'tselected' );
                       }
               } );
        } );
} );
